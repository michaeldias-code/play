<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Piano Professional</title>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.header {
    text-align: center;
    margin-bottom: 40px;
    color: black;
}

.header h1 {
    font-size: 3em;
    font-weight: 300;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.header p {
    font-size: 1.1em;
    opacity: 0.9;
}

.piano-wrapper {
    background: linear-gradient(to bottom, #2a2a2a 0%, #1a1a1a 100%);
    padding: 40px 30px 30px;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.piano-container {
    position: relative;
    display: inline-block;
    padding: 0 10px;
}

.key {
    width: 60px;
    height: 200px;
    background: linear-gradient(to bottom, #ffffff 0%, #f5f5f5 100%);
    border: 1px solid #222;
    border-radius: 0 0 5px 5px;
    display: inline-block;
    position: relative;
    margin-left: -1px;
    box-shadow: 0 5px 10px rgba(0,0,0,0.3);
    user-select: none;
    cursor: pointer;
    transition: all 0.05s ease;
}

.key:hover {
    background: linear-gradient(to bottom, #f0f0f0 0%, #e0e0e0 100%);
}

.black-key {
    width: 38px;
    height: 130px;
    background: linear-gradient(to bottom, #1a1a1a 0%, #000000 100%);
    position: absolute;
    top: 0;
	margin-left: 10px;
    z-index: 10;
    border-radius: 0 0 3px 3px;
    box-shadow: 0 5px 10px rgba(0,0,0,0.5);
}

.black-key:hover {
    background: linear-gradient(to bottom, #2a2a2a 0%, #111111 100%);
}

.active-white {
    background: linear-gradient(to bottom, #6366f1 0%, #4f46e5 100%) !important;
    transform: translateY(2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.4) !important;
}

.active-black {
    background: linear-gradient(to bottom, #8b5cf6 0%, #7c3aed 100%) !important;
    transform: translateY(2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.4) !important;
}

.key-label {
    position: absolute;
    bottom: 10px;
    width: 100%;
    font-size: 11px;
    font-weight: 600;
    text-align: center;
    color: #666;
    pointer-events: none;
}

.key-label .note-name {
    display: block;
    font-size: 13px;
    margin-bottom: 3px;
    color: #333;
}

.key-label .key-code {
    display: block;
    font-size: 9px;
    padding: 2px 4px;
    background: rgba(0,0,0,0.05);
    border-radius: 3px;
    display: inline-block;
}

.black-key .key-label {
    color: #ccc;
    bottom: 5px;
}

.black-key .key-label .note-name {
    color: #fff;
}

.black-key .key-label .key-code {
    background: rgba(255,255,255,0.1);
}

.info-panel {
    margin-top: 30px;
    text-align: center;
    color: rgba(255,255,255,0.8);
    font-size: 0.9em;
}

.currently-playing {
    margin-top: 20px;
    padding: 15px 30px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    backdrop-filter: blur(10px);
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.note-indicator {
    display: inline-block;
    padding: 5px 15px;
    background: rgba(99,102,241,0.8);
    border-radius: 20px;
    margin: 0 5px;
    font-weight: 600;
    animation: fadeIn 0.1s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}

/* Mobile Portrait - Aviso para girar */
@media (max-width: 768px) and (orientation: portrait) {
    body {
        padding: 20px;
        justify-content: center;
    }
    
    .header, .piano-wrapper, .currently-playing, .info-panel {
        display: none;
    }
    
    body::before {
        content: "ðŸ“± â†»";
        font-size: 5em;
        display: block;
        margin-bottom: 20px;
    }
    
    body::after {
        content: "Por favor, gire o dispositivo para o modo paisagem para tocar o piano";
        font-size: 1.2em;
        color: white;
        text-align: center;
        display: block;
        max-width: 300px;
    }
}

/* Mobile Landscape - Otimizado para piano */
@media (max-width: 950px) and (orientation: landscape) {
    body {
        padding: 5px;
        justify-content: flex-start;
    }
    
    .header {
        margin-bottom: 10px;
    }
    
    .header h1 {
        font-size: 1.5em;
        margin-bottom: 5px;
    }
    
    .header p {
        font-size: 0.8em;
    }
    
    .piano-wrapper {
        padding: 15px 10px 10px;
        margin-bottom: 5px;
    }
    
    .piano-container {
        padding: 0 5px;
    }
    
    .key {
        width: 40px;
        height: 140px;
    }
    
    .black-key {
        width: 25px;
        height: 90px;
        margin-left: 23px;
    }
    
    .key-label {
        bottom: 5px;
    }
    
    .key-label .note-name {
        font-size: 10px;
        margin-bottom: 2px;
    }
    
    .key-label .key-code {
        font-size: 7px;
        padding: 1px 3px;
    }
    
    .black-key .key-label {
        bottom: 3px;
    }
    
    .currently-playing {
        margin-top: 10px;
        padding: 8px 15px;
        min-height: 35px;
        font-size: 0.85em;
    }
    
    .note-indicator {
        padding: 3px 10px;
        margin: 0 3px;
        font-size: 0.85em;
    }
    
    .info-panel {
        margin-top: 10px;
        font-size: 0.75em;
    }
}

/* Tablets e telas mÃ©dias */
@media (min-width: 769px) and (max-width: 1024px) {
    .key {
        width: 50px;
        height: 180px;
    }
    
    .black-key {
        width: 32px;
        height: 115px;
		margin-left: 0;
    }
    
    .header h1 {
        font-size: 2.3em;
    }
}
</style>
</head>

<body>

<div class="header">
    <h1>ðŸŽ¹ Piano Profissional</h1>
    <p>Fileira inferior (brancas) + Fileira superior (pretas)</p>
</div>

<div class="piano-wrapper">
    <div class="piano-container" id="piano"></div>
</div>

<div class="currently-playing" id="playing">
    <span style="opacity: 0.6;">Pressione as teclas para tocar...</span>
</div>

<div class="info-panel">
    <p>ðŸŽµ Quase 2 oitavas | C3 atÃ© B4</p>
</div>

<script>
/* ================= BASE MUSICAL ================= */

const C3_BASE_FREQ = 130.81;
const SEMITONE = Math.pow(2, 1/12);
const getFreq = i => C3_BASE_FREQ * Math.pow(SEMITONE, i);

/* ================= MAPEAMENTO DE TECLAS ================= */

// Teclas BRANCAS (fileira inferior) - Shift esquerdo atÃ© Shift direito
const WHITE_KEYS = [
    { code: "ShiftLeft", note: "C3", label: "L Shift" },
    { code: "IntlBackslash", note: "D3", label: "\\" },
    { code: "KeyZ", note: "E3", label: "Z" },
    { code: "KeyX", note: "F3", label: "X" },
    { code: "KeyC", note: "G3", label: "C" },
    { code: "KeyV", note: "A3", label: "V" },
    { code: "KeyB", note: "B3", label: "B" },
    { code: "KeyN", note: "C4", label: "N" },
    { code: "KeyM", note: "D4", label: "M" },
    { code: "Comma", note: "E4", label: "," },
    { code: "Period", note: "F4", label: "." },
    { code: "Slash", note: "G4", label: "/" },
    { code: "IntlRo", note: "A4", label: "?" },  // Tecla ao lado do /
    { code: "ShiftRight", note: "B4", label: "R Shift" }
];

// Teclas PRETAS (fileira superior) - posicionadas entre as brancas correspondentes
const BLACK_KEYS = [
    { code: "Tab", note: "C#3", label: "Tab" },
    { code: "KeyQ", note: "D#3", label: "Q" },
    { code: "KeyW", note: "F#3", label: "W" },
    { code: "KeyE", note: "G#3", label: "E" },
    { code: "KeyR", note: "A#3", label: "R" },
    { code: "KeyT", note: "C#4", label: "T" },
    { code: "KeyY", note: "D#4", label: "Y" },
    { code: "KeyU", note: "F#4", label: "U" },
    { code: "KeyI", note: "G#4", label: "I" },
    { code: "KeyO", note: "A#4", label: "O" }
];

/* ================= GERAR MAPAS ================= */

const CODE_TO_NOTE = {};
const CODE_TO_FREQ = {};

[...WHITE_KEYS, ...BLACK_KEYS].forEach(({code, note}) => {
    const noteIndex = getNoteIndex(note);
    CODE_TO_NOTE[code] = note;
    CODE_TO_FREQ[code] = getFreq(noteIndex);
});

function getNoteIndex(note) {
    const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const octave = parseInt(note.match(/\d+/)[0]);
    const noteName = note.replace(/\d+/, "");
    return (octave - 3) * 12 + notes.indexOf(noteName);
}

/* ================= ÃUDIO MELHORADO (SEM CHIADOS) ================= */

let audioContext = null;
let masterCompressor = null;
let active = {};

function initAudio() {
    if (!audioContext) {
        audioContext = new AudioContext();
        
        // Compressor para evitar distorÃ§Ã£o e chiados
        masterCompressor = audioContext.createDynamicsCompressor();
        masterCompressor.threshold.setValueAtTime(-20, audioContext.currentTime);
        masterCompressor.knee.setValueAtTime(10, audioContext.currentTime);
        masterCompressor.ratio.setValueAtTime(4, audioContext.currentTime);
        masterCompressor.attack.setValueAtTime(0.003, audioContext.currentTime);
        masterCompressor.release.setValueAtTime(0.1, audioContext.currentTime);
        masterCompressor.connect(audioContext.destination);
    }
}

function startNote(code) {
    if (active[code]) return;
    initAudio();

    const freq = CODE_TO_FREQ[code];
    const now = audioContext.currentTime;
    
    // Gain principal
    const mainGain = audioContext.createGain();
    
    // Filtro passa-baixa para suavizar o som
    const filter = audioContext.createBiquadFilter();
    filter.type = "lowpass";
    filter.frequency.setValueAtTime(3000, now);
    filter.Q.setValueAtTime(1, now);
    
    mainGain.connect(filter);
    filter.connect(masterCompressor);

    // HarmÃ´nicos mais suaves
    const harmonics = [
        { r: 1, g: 0.6 },
        { r: 2, g: 0.25 },
        { r: 3, g: 0.15 },
        { r: 4, g: 0.08 },
        { r: 5, g: 0.04 }
    ];

    const oscillators = [];
    
    harmonics.forEach(h => {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        
        osc.type = "sine";
        osc.frequency.setValueAtTime(freq * h.r, now);
        
        gain.gain.setValueAtTime(h.g, now);
        
        osc.connect(gain);
        gain.connect(mainGain);
        osc.start(now);
        oscillators.push(osc);
    });

    // Envelope ADSR suave
    mainGain.gain.setValueAtTime(0, now);
    mainGain.gain.linearRampToValueAtTime(0.4, now + 0.01);
    mainGain.gain.exponentialRampToValueAtTime(0.3, now + 0.15);
    mainGain.gain.exponentialRampToValueAtTime(0.2, now + 0.8);

    active[code] = { mainGain, oscillators, filter };
    updateVisual(CODE_TO_NOTE[code], true);
    updatePlaying();
}

function stopNote(code) {
    const n = active[code];
    if (!n) return;

    const now = audioContext.currentTime;
    
    // Release suave
    n.mainGain.gain.cancelScheduledValues(now);
    n.mainGain.gain.setValueAtTime(n.mainGain.gain.value, now);
    n.mainGain.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
    
    n.oscillators.forEach(o => o.stop(now + 0.9));

    delete active[code];
    updateVisual(CODE_TO_NOTE[code], false);
    updatePlaying();
}

/* ================= VISUAL ================= */

function updateVisual(note, on) {
    const el = document.getElementById("key-" + note);
    if (!el) return;
    el.classList.toggle(note.includes("#") ? "active-black" : "active-white", on);
}

function updatePlaying() {
    const playingDiv = document.getElementById("playing");
    const playingNotes = Object.keys(active).map(code => CODE_TO_NOTE[code]);
    
    if (playingNotes.length === 0) {
        playingDiv.innerHTML = '<span style="opacity: 0.6;">Pressione as teclas para tocar...</span>';
    } else {
        playingDiv.innerHTML = playingNotes
            .map(note => `<span class="note-indicator">${note}</span>`)
            .join('');
    }
}

/* ================= PIANO ================= */

function generatePiano() {
    const piano = document.getElementById("piano");
    let whiteIndex = 0;

    // Criar teclas brancas
    WHITE_KEYS.forEach(({code, note, label}) => {
        const el = document.createElement("div");
        el.id = "key-" + note;
        el.className = "key";
        el.dataset.whiteIndex = whiteIndex;
        el.dataset.code = code;

        const labelEl = document.createElement("div");
        labelEl.className = "key-label";
        labelEl.innerHTML = `
            <span class="note-name">${note}</span>
            <span class="key-code">${label}</span>
        `;
        el.appendChild(labelEl);

        el.addEventListener("mousedown", () => startNote(code));
        el.addEventListener("mouseup", () => stopNote(code));
        el.addEventListener("mouseleave", () => { if (active[code]) stopNote(code); });

        piano.appendChild(el);
        whiteIndex++;
    });

    // Criar teclas pretas nas posiÃ§Ãµes corretas
    const blackPositions = {
        "C#3": 0.5, "D#3": 1.5,
        "F#3": 3.5, "G#3": 4.5, "A#3": 5.5,
        "C#4": 7.5, "D#4": 8.5,
        "F#4": 10.5, "G#4": 11.5, "A#4": 12.5
    };

    BLACK_KEYS.forEach(({code, note, label}) => {
        const el = document.createElement("div");
        el.id = "key-" + note;
        el.className = "key black-key";
        el.dataset.code = code;

        const labelEl = document.createElement("div");
        labelEl.className = "key-label";
        labelEl.innerHTML = `
            <span class="note-name">${note}</span>
            <span class="key-code">${label}</span>
        `;
        el.appendChild(labelEl);

        el.addEventListener("mousedown", () => startNote(code));
        el.addEventListener("mouseup", () => stopNote(code));
        el.addEventListener("mouseleave", () => { if (active[code]) stopNote(code); });

		const whiteKeyWidth = piano.querySelector('.key:not(.black-key)').offsetWidth;
		el.style.left = (position * whiteKeyWidth) + "px";
        piano.appendChild(el);
    });
}

generatePiano();

/* ================= TECLADO ================= */

const pressedKeys = new Set();

document.addEventListener("keydown", e => {
    // Prevenir comportamento padrÃ£o de todas as teclas do piano
    if (CODE_TO_FREQ[e.code]) {
        e.preventDefault();
        e.stopPropagation();
        
        if (!pressedKeys.has(e.code)) {
            pressedKeys.add(e.code);
            startNote(e.code);
        }
    }
}, true);

document.addEventListener("keyup", e => {
    if (CODE_TO_FREQ[e.code]) {
        e.preventDefault();
        e.stopPropagation();
        
        pressedKeys.delete(e.code);
        stopNote(e.code);
    }
}, true);

window.addEventListener("blur", () => {
    pressedKeys.clear();
    Object.keys(active).forEach(code => stopNote(code));
});
</script>

</body>
</html>
