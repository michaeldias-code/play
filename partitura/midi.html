<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador MIDI Profissional (Classe JS)</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; }
        button { background-color: #3498db; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-top: 15px; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        .code-snippet { background-color: #ecf0f1; padding: 10px; border-radius: 5px; margin-top: 10px; font-family: monospace; overflow-x: auto; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Classe Geradora de Arquivos MIDI</h1>
        <p>Abaixo está a estrutura de uma classe profissional que gera um arquivo MIDI com duas pistas (Piano e Baixo) e andamento definido.</p>
        <button onclick="new MidiGenerator().generateAndDownload()">Gerar e Baixar Composição</button>
        
        <h2>Exemplo de Uso:</h2>
        <div class="code-snippet">
            // Dentro de uma função ou evento:<br>
            const gerador = new MidiGenerator();<br>
            gerador.generateAndDownload("Minha_Composicao.mid");
        </div>
    </div>
    
    <script src="https://unpkg.com/midi-writer-js@2.1.4/build/midi-writer-js.min.js"></script>

    <script>
        /**
         * Classe que encapsula a lógica de composição e exportação MIDI.
         */
        class MidiGenerator {
            constructor() {
                // A biblioteca MidiWriterJS precisa ser carregada globalmente.
                if (typeof MidiWriter === 'undefined') {
                    console.error("MidiWriterJS não foi carregada. Verifique a conexão com a CDN.");
                    return;
                }
                this.Writer = new MidiWriter.Writer();
                this.tempo = 120; // BPM padrão
            }

            /**
             * Adiciona uma nova pista ao arquivo MIDI.
             * @param {number} instrumentCode - Código GM (General MIDI, ex: 1=Piano, 33=Baixo Acústico).
             * @param {Array<object>} events - Array de objetos de notas ({ pitch, duration, velocity }).
             * @returns {MidiWriter.Track} A pista criada.
             */
            addTrack(instrumentCode, events) {
                const track = new MidiWriter.Track();
                
                // 1. Configurações da Pista
                track.setTempo(this.tempo);
                track.addEvent(new MidiWriter.ProgramChangeEvent({ instrument: instrumentCode }));

                // 2. Adiciona os Eventos de Notas
                events.forEach(event => {
                    track.addEvent(
                        new MidiWriter.NoteEvent({
                            pitch: event.pitch,
                            duration: event.duration,
                            velocity: event.velocity || 100
                        })
                    );
                });

                this.Writer.addTrack(track);
                return track;
            }

            /**
             * Define o conteúdo musical e exporta o arquivo.
             * @param {string} filename - Nome do arquivo a ser baixado.
             */
            generateAndDownload(filename = 'composicao.mid') {
                if (!this.Writer) return;

                // --- 1. Definição da Composição ---

                // PISTA 1: Piano (Instrumento 1)
                const pianoEvents = [
                    // Notas curtas
                    { pitch: 'C4', duration: '8', velocity: 110 },
                    { pitch: 'E4', duration: '8', velocity: 110 },
                    { pitch: 'G4', duration: '8', velocity: 110 },
                    // Sequência arpejada
                    { pitch: ['C5'], duration: '4', velocity: 100 },
                    { pitch: ['G4'], duration: '4', velocity: 90 },
                    // Acorde prolongado
                    { pitch: ['C4', 'E4', 'G4'], duration: '2', velocity: 120 }
                ];
                this.addTrack(1, pianoEvents); // 1 = Piano Acústico

                // PISTA 2: Baixo (Instrumento 33)
                const bassEvents = [
                    { pitch: 'C2', duration: '2', velocity: 80 }, // C longo
                    { pitch: 'G2', duration: '2', velocity: 80 }, // G longo
                    { pitch: 'F2', duration: '4', velocity: 90 }, // F
                    { pitch: 'E2', duration: '4', velocity: 90 }, // E
                    { pitch: 'C2', duration: '2', velocity: 110 }  // C de volta
                ];
                this.addTrack(33, bassEvents); // 33 = Baixo Elétrico

                // --- 2. Exportação do Arquivo Binário ---

                const dataUri = this.Writer.dataUri();
                
                // Cria link temporário para download
                const link = document.createElement('a');
                link.href = dataUri; 
                link.download = filename; 
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log(`Arquivo MIDI "${filename}" gerado com ${this.Writer.tracks.length} pistas.`);
            }
        }
        
        // Inicializa e aguarda o clique do usuário
        // O código de exportação será executado APENAS quando o botão for clicado.

    </script>
</body>
</html>
